stages:
  - build
  - test

# Global variables
variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  # Docker-in-Docker settings
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""
  DOCKER_DRIVER: overlay2

# Cache pip packages for faster runs
cache:
  paths:
    - .cache/pip
    - .cache/apt
  key: ${CI_COMMIT_REF_SLUG}

build_docker_image:
  stage: docker
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - |
      # Try to pull existing image
      if docker pull $CI_REGISTRY_IMAGE/ci-image:latest 2>/dev/null; then
        echo "Image exists in registry"
        if [ "$FORCE_REBUILD" = "true" ]; then
          echo "Dockerfile or requirements.txt changed - rebuilding..."
          docker build -t $CI_REGISTRY_IMAGE/ci-image:latest .
          docker push $CI_REGISTRY_IMAGE/ci-image:latest
        else
          echo "No changes detected - skipping rebuild"
        fi
      else
        echo "Image not found in registry - building..."
        docker build -t $CI_REGISTRY_IMAGE/ci-image:latest .
        docker push $CI_REGISTRY_IMAGE/ci-image:latest
      fi
  rules:
    # When Dockerfile or requirements.txt changes, force rebuild
    - changes:
        - Dockerfile
        - src/VnaScanGUI/requirements.txt
      variables:
        FORCE_REBUILD: "true"
    # Otherwise, run anyway to check if image exists
    - when: on_success

build_scanner:
  stage: build
  image: gcc:latest
  script:
    - cd src/CliApp
    - make clean
    - make VnaScanMultithreaded CC=gcc 
  artifacts:
    paths:
      - src/CliApp/VnaScanMultithreaded
    expire_in: 1 hour

build_scanner_tests:
  stage: build
  image: gcc:latest
  script:
    - cd src/CliApp
    - make TestVnaScanMultithreaded CC=gcc  
  artifacts:
    paths:
      - test/TestCliApp/TestVnaScanMultithreaded
    expire_in: 1 hour

build_parser:
  stage: build
  image: gcc:latest
  script:
    - cd src/CliApp
    - make clean
    - make VnaCommandParser CC=gcc
  artifacts:
    paths:
      - src/CliApp/VnaCommandParser
    expire_in: 1 hour

build_parser_tests:
  stage: build
  image: gcc:latest
  script:
    - cd src/CliApp
    - make TestVnaCommandParser CC=gcc  
  artifacts:
    paths:
      - test/TestCliApp/TestVnaCommandParser
    expire_in: 1 hour

build_comms_tests:
  stage: build
  image: gcc:latest
  script:
    - cd src/CliApp
    - make TestVnaCommunication CC=gcc  
  artifacts:
    paths:
      - test/TestCliApp/TestVnaCommunication
    expire_in: 1 hour

test:
  stage: test
  image: gcc:latest
  dependencies:
    - build_scanner
    - build_scanner_tests
    - build_parser
    - build_parser_tests
    - build_comms_tests
  needs:
    - job: build_docker_image
      optional: true
    - build_scanner
    - build_scanner_tests
    - build_parser
    - build_parser_tests
    - build_comms_tests
  interruptible: true
  timeout: 10m
  before_script:
    - mkdir -p $APT_CACHE_DIR
    - apt-get update && apt-get -o dir::cache::archives="$APT_CACHE_DIR" install -y python3 python3-pip socat lsof
    - pip3 install --break-system-packages pyserial
  script:
    - echo "____ Starting Virtual Serial Ports ____"
    - socat -d -d pty,raw,echo=0,link=/tmp/vna0_master pty,raw,echo=0,link=/tmp/vna0_slave 2>&1 &
    - socat -d -d pty,raw,echo=0,link=/tmp/vna1_master pty,raw,echo=0,link=/tmp/vna1_slave 2>&1 &
    - sleep 1
    - ls -la /tmp/vna*_slave /tmp/vna*_master
    
    - echo "____ Starting Emulators ____"
    - python3 test/nanovna_emulator.py /tmp/vna0_master --delay 0.001 &
    - python3 test/nanovna_emulator.py /tmp/vna1_master --delay 0.001 &
    - sleep 2
    - echo "Emulators started"
    
    - echo "____ Running Unity Tests ____"
    - cd test/TestCliApp
    - chmod +x TestVnaScanMultithreaded
    - chmod +x TestVnaCommandParser
    - chmod +x TestVnaCommunication
    - lsof -p $$ | wc -l
    - timeout 120s  ./TestVnaScanMultithreaded /tmp/vna0_slave /tmp/vna1_slave  # Pass the two ports, use these for the tests
    - timeout 120s  ./TestVnaCommandParser /tmp/vna0_slave /tmp/vna1_slave < testin.txt
    - timeout 120s  ./TestVnaCommunication /tmp/vna0_slave /tmp/vna1_slave
    - lsof -p $$ | wc -l

  after_script:
    - echo "Killing all background processes..."
    - pkill -9 python3 || true
    - pkill -9 socat || true

test_gui:
  stage: test
  image: $CI_REGISTRY_IMAGE/ci-image:latest
  needs:
    - job: build_docker_image
      optional: true
  interruptible: true
  timeout: 5m
  script:
    - echo "____ Running GUI Tests with Xvfb ____"
    # Start Xvfb (virtual display) and run tests
    - Xvfb :99 -screen 0 1024x768x24 &
    - export DISPLAY=:99
    - sleep 2
    - pytest test/TestVnaScanGUI/ -v --tb=short
  after_script:
    - pkill -9 Xvfb || true
